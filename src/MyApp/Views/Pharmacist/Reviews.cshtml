@using System.Text.Json
@using System.Collections.Generic

@using MyApp.Web.ViewModels
@model ReviewCreateViewModel

@{
    ViewData["Title"] = "Utwórz Zalecenie";
}

<partial name="~/Views/Shared/_PharmacistNav.cshtml" />

<form asp-action="Reviews" asp-controller="Pharmacist" method="post" target="_blank">
    @Html.AntiForgeryToken()

    <div asp-validation-summary="All" class="text-danger mb-3"></div>
    
    <div>
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="medicineName" class="form-label">Nazwa leku</label>
                <input type="text" id="medicineName" class="form-control" />
            </div>
            <div class="col-md-6">
                <label for="medicineAdvice" class="form-label">Dawkowanie</label>
                <input type="text" id="medicineAdvice" class="form-control" />
            </div>
            <div class="col-md-2 d-grid">
                <button type="button" id="addMedAdviceBtn" class="btn btn-primary">Dodaj</button>
            </div>
        </div>

        <div class="row g-3 align-items-end">
            <div class="col-md-10">
                <label for="generalAdvice" class="form-label">Zalecenia</label>
                <input type="text" id="generalAdvice" class="form-control" />
            </div>
            <div class="col-md-2 d-grid">
                <button type="button" id="addGenAdviceBtn" class="btn btn-primary">Dodaj</button>
            </div>
        </div>

        <div id="medAdviceList" class="mt-4"></div>

        <input type="hidden" id="medAdviceHidden" name="Advice" value="" />
    </div>

    <div class="text-center mt-4">
        <button type="submit" class="btn btn-outline-primary me-2">Utwórz PDF</button>
        <button type="button" class="btn btn-outline-secondary" id="clearBtn">Skasuj wszystkie</button>
        <p class="text-muted mt-2">
            PDF otworzy się w nowej karcie.
        </p>
    </div>
</form>

@section Scripts {
    <script>
        (function () {
            const instructionMap = @Html.Raw(JsonSerializer.Serialize(ViewBag.InstructionMap ?? new Dictionary<string, string>()));
            const medicineMap = @Html.Raw(JsonSerializer.Serialize(ViewBag.MedicineMap ?? new Dictionary<string, string>()));

            const instr = (instructionMap && Object.keys(instructionMap).length) ? instructionMap : {};
            const meds  = (medicineMap && Object.keys(medicineMap).length) ? medicineMap : {};

            const maxPairs          = 10;
            const nameInput         = document.getElementById('medicineName');
            const adviceInput       = document.getElementById('medicineAdvice');
            const genAdviceInput    = document.getElementById('generalAdvice');

            const addBtn            = document.getElementById('addMedAdviceBtn');
            const addGenBtn         = document.getElementById('addGenAdviceBtn');

            const list              = document.getElementById('medAdviceList');
            const hidden            = document.getElementById('medAdviceHidden');
            const clearBtn          = document.getElementById('clearBtn');

            let pairs = []; // { medicine name, instructions }
            let genAdvice = "";


            function expandInstruction(text) 
            {
                if (!text) return text;
                const key = text.trim().toUpperCase();
                return Object.prototype.hasOwnProperty.call(instr, key) ? instr[key] : text;
            }

            function expandMedicine(text) 
            {
                if (!text) return text;
                const key = text.trim().toUpperCase();
                return Object.prototype.hasOwnProperty.call(meds, key) ? meds[key] : text;
            }

            function render() 
            {
                list.innerHTML = '';

                // medicine - instruction
                const ul = document.createElement('ul');
                ul.className = 'list-group';
                pairs.forEach((p, idx) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-start text-break';

                    const text = document.createElement('span');
                    text.textContent = escapeHtml(`${p.name}: ${p.advice}`);
                    text.classList.add('me-2');

                    const buttonGroup = document.createElement('div');
                    buttonGroup.classList.add('d-flex', 'flex-column', 'flex-md-row', 'gap-2', 'justify-content-md-end');

                    const btnMod = document.createElement('button');
                    btnMod.type = 'button';
                    btnMod.classList.add('btn', 'btn-sm', 'btn-outline-primary', 'w-100', 'w-md-auto', 'text-nowrap', 'flex-md-1');
                    btnMod.textContent = 'Zmień';
                    btnMod.addEventListener('click', () =>
                    {
                        nameInput.value = p.name;
                        adviceInput.value = p.advice;
                        pairs.splice(idx, 1);
                        nameInput?.focus();
                        render();
                    });

                    const btnDel = document.createElement('button');
                    btnDel.type = 'button';
                    btnDel.classList.add('btn', 'btn-sm', 'btn-outline-danger', 'w-100', 'w-md-auto', 'text-nowrap', 'flex-md-1');
                    btnDel.textContent = 'Usuń';
                    btnDel.addEventListener('click', () => { pairs.splice(idx, 1); render(); });

                    buttonGroup.append(btnMod, btnDel);

                    li.append(text, buttonGroup);
                    ul.appendChild(li);
                });
                // general advice
                if (genAdvice != "")
                {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-start text-break';

                    const text = document.createElement('span');
                    text.textContent = escapeHtml(genAdvice);
                    text.classList.add('me-2');

                    const buttonGroup = document.createElement('div');
                    buttonGroup.classList.add('d-flex', 'flex-column', 'flex-md-row', 'gap-2', 'justify-content-md-end');

                    const btnMod = document.createElement('button');
                    btnMod.type = 'button';
                    btnMod.classList.add('btn', 'btn-sm', 'btn-outline-primary', 'w-100', 'w-md-auto', 'text-nowrap', 'flex-md-1');
                    btnMod.textContent = 'Zmień';
                    btnMod.addEventListener('click', () =>
                    {
                        genAdviceInput.value = genAdvice;
                        genAdvice = "";
                        genAdviceInput?.focus();
                        render();
                    });
                    
                    const btnDel = document.createElement('button');
                    btnDel.type = 'button';
                    btnDel.classList.add('btn', 'btn-sm', 'btn-outline-danger', 'w-100', 'w-md-auto', 'text-nowrap', 'flex-md-1');
                    btnDel.textContent = 'Usuń';
                    btnDel.addEventListener('click', () => 
                    { 
                        genAdvice = ""; 
                        render(); 
                    });
                    
                    buttonGroup.append(btnMod, btnDel);
                    li.append(text, buttonGroup);
                    ul.appendChild(li);
                }

                list.appendChild(ul);
                let text = pairs.map(p => `${p.name} – ${p.advice}`).join('\n');
                text += genAdvice != "" ? `\n${genAdvice}` : "";

                hidden.value = text;
                addBtn.disabled = pairs.length >= maxPairs;
                addGenBtn.disabled = genAdvice != "";
            }

            function escapeHtml(str) 
            {
                return String(str)
                    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function addPair() 
            {
                let name   = (nameInput?.value || '').trim();
                let advice = (adviceInput?.value || '').trim();
                if (!name || !advice) 
                {
                    if (!name) nameInput?.focus(); 
                    else adviceInput?.focus();
                    return;
                }
                if (pairs.length >= maxPairs) return;

                name   = expandMedicine(name);
                advice = expandInstruction(advice);

                pairs.push({ name, advice });
                nameInput.value = '';
                adviceInput.value = '';
                nameInput.focus();
                render();
            }

            function addAdvice()
            {
                let advice = (genAdviceInput?.value || '').trim();
                if (!advice)
                {
                    genAdviceInput?.focus();
                    return;
                }
                if (genAdvice != "")
                {
                    return;
                }
                genAdvice = advice;
                genAdviceInput.value = '';
                nameInput.focus();
                render();
            }

            // --------- EVENTS ---------
            addBtn?.addEventListener('click', addPair);
            addGenBtn?.addEventListener('click', addAdvice);

            nameInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Tab' || e.key === ' ') 
                {
                    const el = e.currentTarget;
                    el.value = expandMedicine(el.value);
                }
                if (e.key === 'Enter') 
                {
                    e.preventDefault();
                    nameInput.value = expandMedicine(nameInput.value);
                    addPair();
                }
            });


            adviceInput?.addEventListener('keydown', function (e) {
                if (e.key === 'Tab' || e.key === ' ') 
                {
                    const el = e.currentTarget; 
                    el.value = expandInstruction(el.value);
                }
                if (e.key === 'Enter') 
                {
                    e.preventDefault();
                    const el = e.currentTarget;
                    el.value = expandInstruction(el.value);
                    addPair();
                }
            });

            genAdviceInput?.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') 
                {
                    e.preventDefault();
                    addAdvice();
                }
            });

            clearBtn?.addEventListener('click', function () {
                pairs = [];
                genAdvice = "";
                render();
                this.closest('form')?.reset();
            });

            render();
        })();
    </script>
}
