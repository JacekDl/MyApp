@model MyApp.Web.ViewModels.TreatmentPlanViewModel

@{
    ViewData["Title"] = "Plan leczenia";
    Layout = "~/Views/Shared/_PharmacistLayout.cshtml";
}

<h3 class="mb-3">Plan leczenia</h3>

<div class="card">
    <div class="card-body">
        <div class="text-break" style="white-space: pre-wrap;">@Model.AdviceFullText</div>

        <hr />

        <div class="mb-2">
            <strong>Data utworzenia:</strong>
            @Model.DateCreated.ToLocalTime().ToString("dd.MM.yyyy")
        </div>

        <div class="mb-2">
            <strong>Data rozpoczęcia:</strong>
            <span id="dateStartedDisplay">
                @(Model.DateStarted.HasValue
                                ? Model.DateStarted.Value.ToLocalTime().ToString("dd.MM.yyyy")
                                : "—")
            </span>
        </div>

        <div class="mb-3">
            <strong>Data ukończenia:</strong>
            <span id="dateCompletedDisplay">
                @(Model.DateCompleted.HasValue
                                ? Model.DateCompleted.Value.ToLocalTime().ToString("dd.MM.yyyy")
                                : "—")
            </span>
        </div>

        <hr />

        <div class="mt-3">
            <h5 class="mb-3">Konwersacja</h5>

            <ul class="list-group mb-3">
                @if (Model.ReviewEntries != null && Model.ReviewEntries.Any() == true)
                {
                    foreach (var entry in Model.ReviewEntries)
                    {
                        <li class="list-group-item">
                            <strong>
                                @(entry.Author == MyApp.Model.enums.ConversationParty.Patient
                                                    ? "Pacjent"
                                                    : "Ja")
                    </strong>
                    <div class="small">@entry.DateCreated.ToString("yyyy-MM-dd HH:mm")</div>
                    <div class="text-break" style="white-space: pre-wrap;">@entry.Text</div>
                </li>
                            }
                }
                else
                {
                    <li class="list-group-item text-muted">
                        Brak wiadomości. Napisz pierwszą.
                    </li>
                }
            </ul>

            <form asp-controller="Conversation"
                  asp-action="AddTreatmentPlanMessage"
                  asp-route-number="@Model.Number"
                  method="post"
                  id="sendForm">
                @Html.AntiForgeryToken()

                <div class="mb-2">
                    <textarea name="text"
                              class="form-control"
                              rows="3"
                              maxlength="500"
                              placeholder="Wpisz wiadomość tutaj..."
                              required></textarea>
                </div>
            </form>

            <div class="d-flex justify-content-center gap-2">
                <a asp-controller="Pharmacist"
                   asp-action="CheckCompliance"
                   asp-route-number="@Model.Number"
                   class="btn btn-secondary">
                    Zgodność terapii
                </a>

                <button type="submit"
                        form="sendForm"
                        class="btn btn-secondary">
                    Dodaj wiadomość
                </button>
            </div>
        </div>
    </div>
</div>
